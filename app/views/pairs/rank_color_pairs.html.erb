<h1 style="text-align:center">Welcome to Color Pair Ranker!</h1>
<h2 style="text-align:center">Which color pair do you like better?</h2>
<p style="text-align:center">Select up to <%= @max_pairs %> ugly pairs and <%= @max_pairs %> great pairs!</p>

<div style="display: flex; justify-content: center;">

  <!-- Ugly pairs column -->
  <div id="ugly_pairs" class="sortable-list" style="flex: 1;">
    <% if @ugly_pairs.present? %>
      <h3>Top Ugly Pairs</h3>
      <ul id="ugly_pairs_list" style="list-style-type:none; padding:0;">

        <% @ugly_pairs.take(@max_pairs).each do |color_pair_vote| %>
          <li data-id="<%= color_pair_vote.id %>" style="margin: 10px 0; cursor: grab; display: flex; justify-content: center;">
            <div class="pair-side-color-box" style="background-color:<%= color_pair_vote.left_color %>;"></div>
            <div class="pair-side-color-box" style="background-color:<%= color_pair_vote.right_color %>;"></div>
          </li>
        <% end %>

      </ul>
      <% end %>
  </div>

  <!-- Middle Column: Color Box Voting -->
  <div style="flex: 1; text-align: center;">
    <% unless @show_pikachu %>

      <!-- Color Pair Display -->
      <div style="display: flex; justify-content: center; align-items: center; gap: 39px;">
        <!-- Left Color Box -->
        <form method="get" action="<%= rank_color_pairs_path %>">
          <input type="hidden" name="new_left_color" value="true" />
          <button type="submit" style="border: none; background: none; padding: 0; margin: 0; cursor: pointer;">
            <div class="pair-color-box" style="background-color: <%= @color_pair[0] %>;"></div>
            <p>Hex: <%= @color_pair[0] %></p>
          </button>
        </form>

        <!-- Right Color Box -->
        <form method="get" action="<%= rank_color_pairs_path %>">
          <input type="hidden" name="new_right_color" value="true" />
          <button type="submit" style="border: none; background: none; padding: 0; margin: 0; cursor: pointer;">
            <div class="pair-color-box" style="background-color: <%= @color_pair[1] %>;"></div>
            <p>Hex: <%= @color_pair[0] %></p>
          </button>
        </form>
      </div>


    <% end %>

    <% if @show_pikachu %>
      <!-- Pikachu Meme -->
      <div style="text-align: center;">
        <img src="<%= @image_url %>" alt="Surprised Pikachu" class="meme-box" />
        <small style="font-size: 6px;">
          Image from
          <a href="https://knowyourmeme.com/memes/surprised-pikachu" target="_blank" rel="noopener noreferrer">
            Know Your Meme
          </a>
        </small>
        <p>Pikachu: Iâ€™m surprised</p>
      </div>
    <% end %>



    <!-- Buttons to vote -->
    <div style="text-align: center;">
      <button onclick="submitPairVote('ugly', '<%= @color_pair[0] %>', '<%= @color_pair[1] %>')">Ew, it&rsquo;s ugly</button>
      <button onclick="submitPairVote('nice', '<%= @color_pair[0] %>', '<%= @color_pair[1] %>')">Great Pair!</button>
    </div>

    <!-- Button to get a new pair -->
    <div style="text-align: center;">
      <form method="get" action="<%= rank_color_pairs_path %>">
        <input type="hidden" name="new_pair" value="true" />
        <button type="submit">New Color Pair</button>
      </form>
    </div>

    <!-- Buttons to generate new left or right color -->
    <div style="display: flex; justify-content: center; gap: 4px">

      <!-- Button to get a new left color -->
      <form method="get" action="<%= rank_color_pairs_path %>">
        <input type="hidden" name="new_left_color" value="true" />
        <button type="submit">New Left Color</button>
      </form>

      <!-- Button to get a new right color -->
      <form method="get" action="<%= rank_color_pairs_path %>">
        <input type="hidden" name="new_right_color" value="true" />
        <button type="submit">New Right Color</button>
      </form>
    </div>

    <!-- Reset votes -->
    <div style="text-align: center;">
      <form method="post" action="<%= reset_pairs_path %>">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit">Reset all pairs</button>
      </form>
    </div>

    <!-- Route to Color Pairs page -->
    <div style="text-align: center; margin: 15px">
      <%= link_to "Color Ranker", root_path %>
    </div>

</div>
  
  <!-- Nice pairs column -->
  <div id="nice_pairs" class="sortable-list" style="flex: 1;">
    <% if @nice_pairs.present? %>
      <h3>Top Nice Pairs</h3>
      <ul id="nice_pairs_list" style="list-style:none; padding:0;">

        <% @nice_pairs.each do |color_pair_vote| %>
          <li data-id="<%= color_pair_vote.id %>" style="display:flex; justify-content:center; align-items:center; margin:10px 0; cursor:grab;">
            <div class="pair-side-color-box" style="background-color:<%= color_pair_vote.left_color %>;"></div>
            <div class="pair-side-color-box" style="background-color:<%= color_pair_vote.right_color %>;"></div>
          </li>
        <% end %>

      </ul>
    <% end %>
  </div>

<script>

function submitPairVote(voteType, leftColor, rightColor) {
    console.log("Submitting vote:", voteType);

    fetch('/vote_pair', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': document.querySelector('meta[name="csrf-token"]').content
      },
      body: JSON.stringify({
        vote_type: voteType,
        left_color: leftColor,
        right_color: rightColor,
      })
    })
    .then(response => {
      if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      return response.text();
    })
    .then(data => {
      console.log("Vote submitted successfully");
      window.location.href = '/rank_color_pairs?new_pair=true';
    })
    .catch(error => {
      console.error("Vote submission failed:", error);
    });
  }



document.addEventListener("DOMContentLoaded", function () {
  if (document.getElementById('ugly_pairs_list')) {
    new Sortable(document.getElementById('ugly_pairs_list'), {
      group: 'ugly',
      onEnd: function(evt) {
        updatePosition('ugly_pairs_list', evt.newIndex, evt.oldIndex);
      }
    });
  }

  if (document.getElementById('nice_pairs_list')) {
    new Sortable(document.getElementById('nice_pairs_list'), {
      group: 'nice',
      onEnd: function(evt) {
        updatePosition('nice_pairs_list', evt.newIndex, evt.oldIndex);
      }
    });
  }
});

</script>
