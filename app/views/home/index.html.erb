<h1 style="text-align:center">Welcome to Color Ranker where you can rank ugly colors!</h1>
<h2 style="text-align:center">Is this color ugly?</h2>
<p style="text-align:center">Select up to <%= @max_colors %> ugly colors and <%= @max_colors %> great colors!</p>

<!-- Middle: Ugly | Color Box | Nice -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 30px; gap: 30px;">

  <!-- Left Column: Ugly Colors -->
  <!-- The flex: 1; tells the element how much space it should take up relative to its siblings inside a flex container. -->
  <div id="ugly_colors" class="sortable-list" style="flex: 1;">
    <!-- When someone votes a color as ugly, Top Ugly Colors show up. Otherwise, it's hidden. -->
    <% if @ugly_colors.present? %>
      <h3>Top Ugly Colors</h3>
      <!-- <ul> stands for unordered list. An HTML element used to group a list of items where order doesn't matter (i.e., no numbering). Inside a <ul>, you typically use <li> elements. <ul> auto adds bullet points and denting. The style removes the bullet points and denting. -->
      <!-- The id is defined here, basically a label. The functionality is written in javascript block. -->
      <ul id="ugly_colors_list" style="list-style-type:none; padding: 0;">

        <!-- This pulls from home_controller.rb, where @ugly_colors is an array of colors that has 'is_ugly' set to 'true'. -->
        <!-- .take Ruby method limits the number of @ugly_colors to the value of @max_colors. Taking into account the ordering defined by @ugly_colors in home_controller.rb. -->
        <!-- .each do |color_vote| is a loop. color_vote represents the element in the @ugly_colors array. The following code loops through color_vote element of @ugly_colors. -->
        <% @ugly_colors.take(@max_colors).each do |color_vote| %>
          <!-- <li> is a list that's usually in <ul>. -->
          <!-- data-id is a data attribute. And color_vote.id is the ID # that identifies which color_vote it is, as votes come in. -->
          <li data-id="<%= color_vote.id %>" style="margin: 10px 0; cursor: grab; display: flex; justify-content: center;">
            <div style="width: 75px; height: 50px; background-color: <%= color_vote.hex_color %>; border: 1px solid c#000;"></div>
            <!-- <span> is an inline HTML element used to group and style small chunks of text or content without affecting the layout structure. Rank is hard-coded. -->
            <!-- color_vote.position starts at 0 so to let users see the ranking start at 1, add +1 to color_vote.position. -->
            <span style="font-weight: bold;">Rank:&nbsp;</span>
            <span class="position-number" style="font-weight: normal;"><%= color_vote.position.to_i + 1 %></span>
          </li>
        <% end %>
    
      </ul>
    <% end %>
  </div>


  <!-- Center Column: Color Box and Buttons -->
  <div style="flex: 1; text-align:center;">

    <!-- Logic to show the color box, unless the meme shows up. -->
    <% unless @show_pikachu %>
      <div class="color-box" style="width: 300px; height: 192px; background-color: <%= @hex_color %>; border: 2px solid #000; margin: 0 auto;"></div>
    <% end %>

    <!-- Styling for meme -->
    <% if @show_pikachu %>
      <div style="text-align: center; margin-bottom: 10px;">
        <img src="<%= @image_url %>" alt="Surprised Pikachu" style="max-width: 300px; height: auto;" />
        <br>
        <small style="font-size: 6px;">
          Image from
          <a href="https://knowyourmeme.com/memes/surprised-pikachu" target="_blank" rel="noopener noreferrer">
            Know Your Meme
          </a>
        </small>
        <p style="text-align:center; margin-top: 10px;">Pikachu: I&rsquo;m surprised</p>
      </div>
    <% end %>

    <!-- Logic to show the hex #, unless the meme shows up. -->
    <% unless @show_pikachu %>
      <p style="text-align:center; margin-top: 10px;">Color Code: <%= @hex_color %></p>
    <% end %>

    <!-- Buttons to vote -->
    <div style="text-align:center; margin-top: 10px;">
      <button onclick="submitVote('ugly')">Ew, it&rsquo;s ugly</button>
      <button onclick="submitVote('nice')">Great color</button>
    </div>

    <!-- Button to generate new color only -->
    <div style="text-align:center; margin-top: 10px;">
      <form method="get" action="/">
        <input type="hidden" name="new_color" value="true">
        <button type="submit">Not sure, give me a new color</button>
      </form>
    </div>

    <!-- Reset button for votes -->
    <div style="text-align:center; margin-top: 10px;">
      <form method="post" action="/reset">
        <!-- Adds hidden input field that includes CSRF protection token. Required for "post" methods. -->
        <!-- Analogy: Mailing an envelope. Write stuff (inputs), seal it with stamp (token), drop it mailbox (submit), goes to address (action), handled by someone (controller). -->
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit">Reset</button>
      </form>
    </div>
    
    <!-- Message for max votes, dependent on which vote is maxed. -->
    <% if @message %>
      <p style="color: red; text-align:center; margin-top: 10px;"><%= @message %></p>
    <% end %>

    <!-- Message for when the reset button is clicked. -->
    <% if flash[:notice] %>
      <p style="color: red; text-align:center; margin-top: 10px;"><%= flash[:notice] %></p>
    <% end %>

  </div>

  <!-- Right Column: Nice Colors -->

  <div id="nice_colors" class="sortable-list" style="flex: 1;">
    <% if @nice_colors.present? %>
      <h3>Top Nice Colors</h3>
      <ul id="nice_colors_list" style="list-style-type:none; padding: 0;">
        
        <% @nice_colors.each do |color_vote| %>
          <li data-id="<%= color_vote.id %>" style="margin: 10px 0; cursor: grab; display: flex; justify-content: center;">
            <div style="width: 75px; height: 50px; background-color: <%= color_vote.hex_color %>; border: 1px solid c#000;"></div>
            <span style="font-weight: bold;">Rank:&nbsp;</span>
            <span class="position-number" style="font-weight: normal;"><%= color_vote.position.to_i + 1 %></span>
          </li>
        <% end %>
      
      </ul>
    <% end %>
  </div>


<!-- This is javascript. Use Javascript syntax. -->
<script>

// This creates a function called submitVote and takes in one parameter called 'vote'. In this case, vote is either 'ugly' or 'nice'
function submitVote(vote) {
  // A function that makes network requests. /vote is the route URL being called.
  fetch('/vote', { // Code between here and the next closing bracket is where you configure the request. Basically saying, 'send a request to /vote with this configuration.
    // 'POST' means I'm submitting data to the server. vs 'GET' which retrieves read-only data.
    method: 'POST',
    headers: {
      // Content-Type tells the server 'I'm sending JSON (JavaScript Object Notation) data in the body of this request, otherwise server wouldn't know how to parse the incoming data. 
      'Content-Type': 'application/json',
      // Token protects against CSRF attacks. This token is what Rails expects for Javascript.
      'X-CSRF-Token': '<%= form_authenticity_token %>'
    },
    // This is the actual data I'm sending to the POST request. vote: vote turns into vote: "ugly" for example.
    body: JSON.stringify({ vote: vote })
    // Promise Handler. Runs once the server sends back a response. Response is the reply from /vote URL endpoint
  }).then(response => {
    // response.ok checks to see if server said "Success!"
    if (response.ok) {
      // If the response is 'success', redirect page to /?new_color=true. 
      // Does this trigger Rails app to show a new color on page load?
      window.location.href = "/?new_color=true";
      // If response fails, show the alert to the user.
    } else {
      alert("Failed to submit vote.");
    }
  });
}

document.addEventListener("DOMContentLoaded", function () {
  if (document.getElementById('ugly_colors_list')) {
    new Sortable(document.getElementById('ugly_colors_list'), {
      group: 'ugly',
      onEnd: function(evt) {
        updatePosition('ugly_colors_list', evt.newIndex, evt.oldIndex);
      }
    });
  }

  if (document.getElementById('nice_colors_list')) {
    new Sortable(document.getElementById('nice_colors_list'), {
      group: 'nice',
      onEnd: function(evt) {
        updatePosition('nice_colors_list', evt.newIndex, evt.oldIndex);
      }
    });
  }
});

function updatePosition(listId, newIndex, oldIndex) {
  const list = document.getElementById(listId);
  const orderedIds = Array.from(list.querySelectorAll('li')).map((li) => li.dataset.id);

  // Update the order on the server
  fetch('/update_position', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRF-Token': '<%= form_authenticity_token %>'
    },
    body: JSON.stringify({
      ordered_ids: orderedIds,
      list_type: listId
    })
  }).then(response => {
    if (response.ok) {
      // Once the order is updated successfully, update the position number on the frontend
      const items = list.querySelectorAll('li');
      items.forEach((item, index) => {
        item.querySelector('.position-number').textContent = index + 1; // Update the position number on the frontend
      });
    } else {
      alert('Failed to update order');
    }
  });
}

</script>

<!-- This is Sortable.js library to allow for drag-and-drop functionality -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
