<h1 style="text-align:center">Welcome to Color Ranker where you can rank ugly colors!</h1>
<h2 style="text-align:center">Is this color ugly?</h2>
<p style="text-align:center">Select up to <%= @max_colors %> ugly colors and <%= @max_colors %> great colors!</p>

<!-- Middle: Ugly | Color Box | Nice -->
<div style="display: flex; justify-content: space-between; align-items: flex-start; margin-top: 30px; gap: 30px;">

  <!-- Left Column: Ugly Colors -->
  <div id="ugly_colors" class="sortable-list" style="flex: 1;">
    <% if @ugly_colors.present? %>
      <h3>Top Ugly Colors</h3>
      <ul id="ugly_colors_list" style="list-style-type:none; padding: 0;">
        <% @ugly_colors.each do |color| %>
          <li data-id="<%= color %>" style="margin: 10px 0; cursor: grab; display: flex; justify-content: center;">
            <div style="width: 60px; height: 60px; background-color: <%= color %>; border: 1px solid #000;"></div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>


  <!-- Center Column: Color Box and Buttons -->
  <div style="flex: 1; text-align:center;">

    <% unless @show_pikachu %>
      <div class="color-box" style="width: 300px; height: 192px; background-color: <%= @hex_color %>; border: 2px solid #000; margin: 0 auto;"></div>
    <% end %>

    <% if @show_pikachu %>
      <div style="text-align: center; margin-bottom: 10px;">
        <img src="<%= @image_url %>" alt="Surprised Pikachu" style="max-width: 300px; height: auto;" />
        <br>
        <small style="font-size: 6px;">
          Image from
          <a href="https://knowyourmeme.com/memes/surprised-pikachu" target="_blank" rel="noopener noreferrer">
            Know Your Meme
          </a>
        </small>
        <p style="text-align:center; margin-top: 10px;">Pikachu: I&rsquo;m surprised</p>
      </div>
    <% end %>

    <% unless @show_pikachu %>
      <p style="text-align:center; margin-top: 10px;">Color Code: <%= @hex_color %></p>
    <% end %>

    <div style="text-align:center; margin-top: 10px;">
      <button onclick="submitVote('ugly')">Ew, it&rsquo;s ugly</button>
      <button onclick="submitVote('nice')">Great color</button>
    </div>

    <div style="text-align:center; margin-top: 10px;">
      <form method="get" action="/">
        <input type="hidden" name="new_color" value="true">
        <button type="submit">Not sure, give me a new color</button>
      </form>
    </div>

    <div style="text-align:center; margin-top: 10px;">
      <form method="post" action="/reset">
        <%= hidden_field_tag :authenticity_token, form_authenticity_token %>
        <button type="submit">Reset</button>
      </form>
    </div>

    <% if @message %>
      <p style="color: red; text-align:center; margin-top: 10px;"><%= @message %></p>
    <% end %>

    <% if flash[:notice] %>
      <p style="color: red; text-align:center; margin-top: 10px;"><%= flash[:notice] %></p>
    <% end %>

  </div>

  <!-- Right Column: Nice Colors -->

  <div id="nice_colors" class="sortable-list" style="flex: 1;">
    <% if @nice_colors.present? %>
      <h3>Top Nice Colors</h3>
      <ul id="nice_colors_list" style="list-style-type:none; padding: 0;">
        <% @nice_colors.each do |color| %>
          <li data-id="<%= color %>" style="margin: 10px 0; cursor: grab; display: flex; justify-content: center;">
            <div style="width: 60px; height: 60px; background-color: <%= color %>; border: 1px solid #000;"></div>
          </li>
        <% end %>
      </ul>
    <% end %>
  </div>
</div>

<script>
  function submitVote(vote) {
    fetch('/vote', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      },
      body: JSON.stringify({ vote: vote })
    }).then(response => {
      if (response.ok) {
        window.location.href = "/?new_color=true";
      } else {
        alert("Failed to submit vote.");
      }
    });
  }

  document.addEventListener("DOMContentLoaded", function () {
    if (document.getElementById('ugly_colors_list')) {
      new Sortable(document.getElementById('ugly_colors_list'), {
        group: 'colors',
        onEnd: function(evt) {
          updatePosition('ugly_colors_list', evt.newIndex, evt.oldIndex);
        }
      });
    }

    if (document.getElementById('nice_colors_list')) {
      new Sortable(document.getElementById('nice_colors_list'), {
        group: 'colors',
        onEnd: function(evt) {
          updatePosition('nice_colors_list', evt.newIndex, evt.oldIndex);
        }
      });
    }
  });

  function updatePosition(listId, newIndex, oldIndex) {
    const orderedIds = Array.from(document.querySelectorAll(`#${listId} li`)).map((li) => li.dataset.id);
    fetch('/update_position', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRF-Token': '<%= form_authenticity_token %>'
      },
      body: JSON.stringify({ ordered_ids: orderedIds })
    }).then(response => {
      if (!response.ok) {
        alert('Failed to update order');
      }
    });
  }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>


